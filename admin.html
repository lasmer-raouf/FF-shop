<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FierroFit Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Montserrat', sans-serif;
            scroll-behavior: smooth;
        }
        
        :root {
            --primary: #111111;
            --secondary: #ffffff;
            --accent: #e30613;
        }

        .admin-page {
            display: none;
        }
        .admin-page.active {
            display: block;
        }
        .sidebar-item.active {
            background-color: var(--accent);
            color: white;
        }
        .table-header th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }
        .table-body td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .table-body tr:hover {
            background-color: #f9fafb;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group input[type="url"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            color: #1f2937;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(227, 6, 19, 0.2);
        }
        .btn-primary {
            background-color: var(--accent);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #c20511;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #22c55e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .modal-admin {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content-admin {
            background-color: #ffffff;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .close-button-admin {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close-button-admin:hover {
            color: #e30613;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex">

    <!-- Admin Login Page -->
    <div id="admin-login-page" class="fixed inset-0 bg-black text-white flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-xl shadow-lg text-center max-w-md w-full">
            <h1 class="text-3xl font-bold mb-8">ADMIN LOGIN</h1>
            <form id="admin-login-form" class="space-y-6">
                <div>
                    <input type="email" id="admin-email" placeholder="Email Address" class="w-full px-4 py-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-600" required>
                </div>
                <div>
                    <input type="password" id="admin-password" placeholder="Password" class="w-full px-4 py-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-600" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition duration-300">
                    LOGIN
                </button>
            </form>
            <p id="login-message" class="mt-4 text-red-400"></p>
        </div>
    </div>

    <!-- Admin Dashboard (Hidden until logged in) -->
    <div id="admin-dashboard" class="flex flex-1 hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col">
            <h2 class="text-3xl font-bold text-white mb-8">FIERRO<span class="text-red-600">FIT</span> <span class="text-lg block">Admin</span></h2>
            <nav class="flex-1">
                <ul>
                    <li class="mb-2">
                        <a href="#" class="block px-4 py-2 rounded-lg hover:bg-gray-700 transition sidebar-item active" data-page="dashboard">Dashboard</a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="block px-4 py-2 rounded-lg hover:bg-gray-700 transition sidebar-item" data-page="products">Products</a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="block px-4 py-2 rounded-lg hover:bg-gray-700 transition sidebar-item" data-page="orders">Orders</a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="block px-4 py-2 rounded-lg hover:bg-gray-700 transition sidebar-item" data-page="coupons">Coupons</a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="block px-4 py-2 rounded-lg hover:bg-gray-700 transition sidebar-item" data-page="users">Users & Staff</a>
                    </li>
                    <!-- Add more sidebar items as needed -->
                </ul>
            </nav>
            <button id="admin-logout-button" class="w-full bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition">Logout</button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 bg-gray-100 overflow-y-auto">
            <!-- Dashboard Page -->
            <div id="dashboard" class="admin-page active">
                <h1 class="text-4xl font-bold mb-8">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-600">Total Sales</h3>
                        <p id="dashboard-total-sales" class="text-3xl font-bold text-red-600 mt-2">€0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-600">Total Orders</h3>
                        <p id="dashboard-total-orders" class="text-3xl font-bold text-black mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-600">Products Sold</h3>
                        <p id="dashboard-products-sold" class="text-3xl font-bold text-black mt-2">0</p>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Recent Orders</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="table-header">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-recent-orders" class="table-body">
                                <!-- Recent orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Page -->
            <div id="products" class="admin-page">
                <h1 class="text-4xl font-bold mb-8">Product Management</h1>
                <button class="btn-primary mb-6" onclick="openProductModal()">Add New Product</button>
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock (M)</th>
                                <th>New</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body" class="table-body">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Page -->
            <div id="orders" class="admin-page">
                <h1 class="text-4xl font-bold mb-8">Order Management</h1>
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr>
                                <th>Order ID</th>
                                <th>Customer Email</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Tracking</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="table-body">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Coupons Page -->
            <div id="coupons" class="admin-page">
                <h1 class="text-4xl font-bold mb-8">Coupon Management</h1>
                <button class="btn-primary mb-6" onclick="openCouponModal()">Add New Coupon</button>
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr>
                                <th>ID</th>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Min Purchase</th>
                                <th>Usage</th>
                                <th>Expires</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coupons-table-body" class="table-body">
                            <!-- Coupons will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users & Staff Page -->
            <div id="users" class="admin-page">
                <h1 class="text-4xl font-bold mb-8">Users & Staff Management</h1>
                <button class="btn-primary mb-6" onclick="openUserModal()">Add New Staff/Admin</button>
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="table-body">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal-admin flex items-center justify-center">
        <div class="modal-content-admin">
            <span class="close-button-admin" onclick="closeProductModal()">&times;</span>
            <h2 id="product-modal-title" class="text-2xl font-bold mb-6">Add New Product</h2>
            <form id="product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="product-name">Name</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-price">Price (€)</label>
                    <input type="number" step="0.01" id="product-price" required>
                </div>
                <div class="form-group">
                    <label for="product-category">Category</label>
                    <input type="text" id="product-category">
                </div>
                <div class="form-group">
                    <label for="product-subcategory">Sub Category</label>
                    <input type="text" id="product-subcategory">
                </div>
                <div class="form-group">
                    <label for="product-image-url">Main Image URL</label>
                    <input type="url" id="product-image-url">
                </div>
                <div class="form-group">
                    <label for="product-images">Additional Image URLs (comma-separated)</label>
                    <input type="text" id="product-images">
                </div>
                <div class="form-group col-span-full">
                    <label for="product-description">Description</label>
                    <textarea id="product-description" rows="3"></textarea>
                </div>
                <div class="form-group col-span-full">
                    <label for="product-features">Features (comma-separated)</label>
                    <input type="text" id="product-features">
                </div>
                <div class="form-group">
                    <label for="product-sizes">Sizes & Stock (JSON: {"S":10, "M":20})</label>
                    <textarea id="product-sizes" rows="2" placeholder='{"S":10, "M":20, "L":15}'></textarea>
                </div>
                <div class="form-group">
                    <label for="product-colors">Colors (JSON: [{"name":"Black","hex":"#000"}])</label>
                    <textarea id="product-colors" rows="2" placeholder='[{"name":"Black","hex":"#000000"}, {"name":"Red","hex":"#FF0000"}]'></textarea>
                </div>
                <div class="form-group flex items-center space-x-4">
                    <input type="checkbox" id="product-is-new" class="rounded text-red-600">
                    <label for="product-is-new" class="mb-0">Is New Arrival?</label>
                </div>
                <div class="form-group flex items-center space-x-4">
                    <input type="checkbox" id="product-is-bestseller" class="rounded text-red-600">
                    <label for="product-is-bestseller" class="mb-0">Is Bestseller?</label>
                </div>
                <div class="col-span-full flex justify-end space-x-4 mt-4">
                    <button type="button" class="btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="coupon-modal" class="modal-admin flex items-center justify-center">
        <div class="modal-content-admin">
            <span class="close-button-admin" onclick="closeCouponModal()">&times;</span>
            <h2 id="coupon-modal-title" class="text-2xl font-bold mb-6">Add New Coupon</h2>
            <form id="coupon-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="coupon-code">Coupon Code</label>
                    <input type="text" id="coupon-code" required>
                </div>
                <div class="form-group">
                    <label for="coupon-discount-type">Discount Type</label>
                    <select id="coupon-discount-type" required>
                        <option value="percentage">Percentage</option>
                        <option value="fixed">Fixed Amount</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="coupon-discount-value">Discount Value</label>
                    <input type="number" step="0.01" id="coupon-discount-value" required>
                </div>
                <div class="form-group">
                    <label for="coupon-min-purchase">Minimum Purchase (€)</label>
                    <input type="number" step="0.01" id="coupon-min-purchase" value="0">
                </div>
                <div class="form-group">
                    <label for="coupon-usage-limit">Usage Limit (total)</label>
                    <input type="number" id="coupon-usage-limit" placeholder="Leave empty for unlimited">
                </div>
                <div class="form-group">
                    <label for="coupon-expires-at">Expires At</label>
                    <input type="date" id="coupon-expires-at">
                </div>
                <div class="form-group flex items-center space-x-4 col-span-full">
                    <input type="checkbox" id="coupon-is-active" class="rounded text-red-600" checked>
                    <label for="coupon-is-active" class="mb-0">Is Active?</label>
                </div>
                <div class="col-span-full flex justify-end space-x-4 mt-4">
                    <button type="button" class="btn-secondary" onclick="closeCouponModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Coupon</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal (for Staff/Admin creation/edit) -->
    <div id="user-modal" class="modal-admin flex items-center justify-center">
        <div class="modal-content-admin">
            <span class="close-button-admin" onclick="closeUserModal()">&times;</span>
            <h2 id="user-modal-title" class="text-2xl font-bold mb-6">Add New Staff/Admin</h2>
            <form id="user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="user-fullname">Full Name</label>
                    <input type="text" id="user-fullname" required>
                </div>
                <div class="form-group">
                    <label for="user-email">Email</label>
                    <input type="email" id="user-email" required>
                </div>
                <div class="form-group">
                    <label for="user-password">Password</label>
                    <input type="password" id="user-password" placeholder="Required for new users">
                </div>
                <div class="form-group">
                    <label for="user-role">Role</label>
                    <select id="user-role" required>
                        <option value="customer">Customer</option>
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-end space-x-4 mt-4">
                    <button type="button" class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- API Configuration ---
        const API_BASE_URL = 'http://localhost:3000/api'; // IMPORTANT: Change this to your deployed backend URL in production!

        // --- Admin Global State ---
        let adminAuthToken = sessionStorage.getItem('adminAuthToken') || null;
        let adminCurrentUser = JSON.parse(sessionStorage.getItem('adminCurrentUser')) || null;
        let currentEditProductId = null;
        let currentEditCouponId = null;
        let currentEditUserId = null;

        // --- Utility Functions ---
        function getAdminAuthHeaders() {
            return adminAuthToken ? {
                'Authorization': `Bearer ${adminAuthToken}`,
                'Content-Type': 'application/json'
            } : { 'Content-Type': 'application/json' };
        }

        function showAdminPage(pageId) {
            document.querySelectorAll('.admin-page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.sidebar-item[data-page="${pageId}"]`).classList.add('active');

            // Load data for the active page
            if (pageId === 'dashboard') fetchDashboardData();
            else if (pageId === 'products') fetchProductsAdmin();
            else if (pageId === 'orders') fetchOrdersAdmin();
            else if (pageId === 'coupons') fetchCouponsAdmin();
            else if (pageId === 'users') fetchUsersAdmin();
        }

        // --- Admin Login/Logout ---
        async function adminLogin(event) {
            event.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const loginMessage = document.getElementById('login-message');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.user.role === 'admin' || data.user.role === 'staff') {
                        sessionStorage.setItem('adminAuthToken', data.token);
                        sessionStorage.setItem('adminCurrentUser', JSON.stringify(data.user));
                        adminAuthToken = data.token;
                        adminCurrentUser = data.user;
                        document.getElementById('admin-login-page').classList.add('hidden');
                        document.getElementById('admin-dashboard').classList.remove('hidden');
                        showAdminPage('dashboard'); // Show dashboard after login
                    } else {
                        loginMessage.textContent = 'Access denied: Not an admin or staff account.';
                    }
                } else {
                    loginMessage.textContent = data.message || 'Login failed: Invalid credentials.';
                }
            } catch (error) {
                console.error('Admin login error:', error);
                loginMessage.textContent = 'An error occurred during login. Please try again.';
            }
        }

        function adminLogout() {
            sessionStorage.removeItem('adminAuthToken');
            sessionStorage.removeItem('adminCurrentUser');
            adminAuthToken = null;
            adminCurrentUser = null;
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('admin-login-page').classList.remove('hidden');
            document.getElementById('admin-login-form').reset(); // Clear form
            document.getElementById('login-message').textContent = '';
        }

        // Attach event listeners
        document.getElementById('admin-login-form').addEventListener('submit', adminLogin);
        document.getElementById('admin-logout-button').addEventListener('click', adminLogout);
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                showAdminPage(e.target.dataset.page);
            });
        });

        // --- Dashboard Data ---
        async function fetchDashboardData() {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/reports/sales`, {
                    headers: getAdminAuthHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('dashboard-total-sales').textContent = `€${parseFloat(data.totalSalesAmount).toFixed(2)}`;
                    document.getElementById('dashboard-total-orders').textContent = data.totalOrders;
                    document.getElementById('dashboard-products-sold').textContent = data.totalProductsSold;
                } else {
                    console.error('Failed to fetch sales data:', data.message);
                    alert('Failed to load dashboard data.');
                }

                // Fetch recent orders
                const ordersResponse = await fetch(`${API_BASE_URL}/orders`, {
                    headers: getAdminAuthHeaders()
                });
                const ordersData = await ordersResponse.json();
                if (ordersResponse.ok) {
                    renderRecentOrders(ordersData.slice(0, 5)); // Show top 5 recent orders
                } else {
                    console.error('Failed to fetch recent orders:', ordersData.message);
                }

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                alert('An error occurred while fetching dashboard data.');
            }
        }

        function renderRecentOrders(orders) {
            const tableBody = document.getElementById('dashboard-recent-orders');
            tableBody.innerHTML = '';
            if (orders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No recent orders.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const row = `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.user ? order.user.email : 'N/A'}</td>
                        <td>${new Date(order.orderDate).toLocaleDateString()}</td>
                        <td>€${parseFloat(order.totalAmount).toFixed(2)}</td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${getOrderStatusClass(order.status)}">${order.status.toUpperCase()}</span></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function getOrderStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'processing': return 'bg-blue-100 text-blue-800';
                case 'shipped': return 'bg-purple-100 text-purple-800';
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // --- Product Management ---
        async function fetchProductsAdmin() {
            try {
                const response = await fetch(`${API_BASE_URL}/products`, {
                    headers: getAdminAuthHeaders()
                });
                const products = await response.json();
                renderProductsTable(products);
            } catch (error) {
                console.error('Error fetching products for admin:', error);
                alert('Failed to load products for admin panel.');
            }
        }

        function renderProductsTable(products) {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = '';
            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No products found.</td></tr>';
                return;
            }
            products.forEach(product => {
                const stockM = product.sizes && product.sizes.M !== undefined ? product.sizes.M : 'N/A';
                const row = `
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.category || 'N/A'}</td>
                        <td>€${parseFloat(product.price).toFixed(2)}</td>
                        <td>${stockM}</td>
                        <td>${product.isNew ? 'Yes' : 'No'}</td>
                        <td class="space-x-2">
                            <button class="btn-secondary text-sm" onclick="editProduct(${product.id})">Edit</button>
                            <button class="btn-danger text-sm" onclick="deleteProduct(${product.id})">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function openProductModal(product = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            form.reset(); // Clear form fields
            currentEditProductId = null;

            document.getElementById('product-modal-title').textContent = 'Add New Product';
            document.getElementById('product-password').required = true; // Password required for new users

            if (product) {
                document.getElementById('product-modal-title').textContent = 'Edit Product';
                currentEditProductId = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-price').value = parseFloat(product.price);
                document.getElementById('product-category').value = product.category || '';
                document.getElementById('product-subcategory').value = product.subCategory || '';
                document.getElementById('product-image-url').value = product.imageUrl || '';
                document.getElementById('product-images').value = product.images ? product.images.join(', ') : '';
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-features').value = product.features ? product.features.join(', ') : '';
                document.getElementById('product-sizes').value = JSON.stringify(product.sizes || {});
                document.getElementById('product-colors').value = JSON.stringify(product.colors || []);
                document.getElementById('product-is-new').checked = product.isNew;
                document.getElementById('product-is-bestseller').checked = product.isBestseller;
            }
            modal.style.display = 'flex';
        }

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value || null,
                subCategory: document.getElementById('product-subcategory').value || null,
                imageUrl: document.getElementById('product-image-url').value || null,
                images: document.getElementById('product-images').value.split(',').map(s => s.trim()).filter(s => s) || [],
                description: document.getElementById('product-description').value || null,
                features: document.getElementById('product-features').value.split(',').map(s => s.trim()).filter(s => s) || [],
                isNew: document.getElementById('product-is-new').checked,
                isBestseller: document.getElementById('product-is-bestseller').checked,
            };

            try {
                formData.sizes = JSON.parse(document.getElementById('product-sizes').value);
            } catch (error) {
                alert('Invalid JSON for Sizes. Please use format: {"S":10, "M":20}');
                return;
            }
            try {
                formData.colors = JSON.parse(document.getElementById('product-colors').value);
            } catch (error) {
                alert('Invalid JSON for Colors. Please use format: [{"name":"Black","hex":"#000000"}]');
                return;
            }

            const method = currentEditProductId ? 'PUT' : 'POST';
            const url = currentEditProductId ? `${API_BASE_URL}/products/${currentEditProductId}` : `${API_BASE_URL}/products`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAdminAuthHeaders(),
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    closeProductModal();
                    fetchProductsAdmin(); // Refresh table
                } else {
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('Product save error:', error);
                alert('An error occurred while saving the product.');
            }
        });

        async function editProduct(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${id}`, {
                    headers: getAdminAuthHeaders()
                });
                const product = await response.json();
                if (response.ok) {
                    openProductModal(product);
                } else {
                    alert(`Error fetching product: ${product.message}`);
                }
            } catch (error) {
                console.error('Error fetching product for edit:', error);
                alert('An error occurred while fetching product for edit.');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/products/${id}`, {
                    method: 'DELETE',
                    headers: getAdminAuthHeaders()
                });

                if (response.ok) {
                    alert('Product deleted successfully.');
                    fetchProductsAdmin(); // Refresh table
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('Product delete error:', error);
                alert('An error occurred while deleting the product.');
            }
        }

        // --- Order Management ---
        async function fetchOrdersAdmin() {
            try {
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    headers: getAdminAuthHeaders()
                });
                const orders = await response.json();
                renderOrdersTable(orders);
            } catch (error) {
                console.error('Error fetching orders for admin:', error);
                alert('Failed to load orders for admin panel.');
            }
        }

        function renderOrdersTable(orders) {
            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = '';
            if (orders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No orders found.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const orderDate = new Date(order.orderDate).toLocaleDateString();
                const row = `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.user ? order.user.email : 'N/A'}</td>
                        <td>${orderDate}</td>
                        <td>€${parseFloat(order.totalAmount).toFixed(2)}</td>
                        <td>
                            <select class="px-2 py-1 rounded text-xs" onchange="updateOrderStatus(${order.id}, this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" value="${order.trackingNumber || ''}" placeholder="Tracking No." class="w-24 text-xs px-1 py-0.5 border rounded" onblur="updateOrderTracking(${order.id}, this.value)">
                        </td>
                        <td class="space-x-2">
                            <button class="btn-secondary text-sm" onclick="viewOrderDetails(${order.id})">View Details</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: getAdminAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(`Order ${orderId} status updated to ${newStatus}.`);
                    fetchOrdersAdmin(); // Refresh table
                } else {
                    alert(`Error updating status: ${data.message}`);
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('An error occurred while updating order status.');
            }
        }

        async function updateOrderTracking(orderId, trackingNumber) {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/shipping`, {
                    method: 'PATCH',
                    headers: getAdminAuthHeaders(),
                    body: JSON.stringify({ trackingNumber: trackingNumber || null })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(`Order ${orderId} tracking updated.`);
                    fetchOrdersAdmin(); // Refresh table
                } else {
                    alert(`Error updating tracking: ${data.message}`);
                }
            } catch (error) {
                console.error('Error updating order tracking:', error);
                alert('An error occurred while updating order tracking.');
            }
        }

        async function viewOrderDetails(orderId) {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                    headers: getAdminAuthHeaders()
                });
                const order = await response.json();
                if (response.ok) {
                    let detailsHtml = `
                        <h3 class="text-xl font-bold mb-4">Order #${order.id} Details</h3>
                        <p><strong>Customer:</strong> ${order.user ? order.user.fullName : 'N/A'} (${order.user ? order.user.email : 'N/A'})</p>
                        <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                        <p><strong>Total Amount:</strong> €${parseFloat(order.totalAmount).toFixed(2)}</p>
                        <p><strong>Status:</strong> ${order.status.toUpperCase()}</p>
                        <p><strong>Shipping Address:</strong> ${order.shippingAddress}</p>
                        <p><strong>Tracking Number:</strong> ${order.trackingNumber || 'N/A'}</p>
                        <p><strong>Discount Used:</strong> €${parseFloat(order.discountAmount).toFixed(2)} (${order.couponCodeUsed || 'None'})</p>
                        <h4 class="font-bold mt-4 mb-2">Items:</h4>
                        <ul class="list-disc pl-5">
                    `;
                    order.items.forEach(item => {
                        detailsHtml += `<li>${item.quantity} x ${item.product.name} (Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}) @ €${parseFloat(item.priceAtPurchase).toFixed(2)} each</li>`;
                    });
                    detailsHtml += `</ul>`;

                    alert(detailsHtml); // Use a custom modal for better display
                } else {
                    alert(`Error fetching order details: ${order.message}`);
                }
            } catch (error) {
                console.error('Error fetching order details:', error);
                alert('An error occurred while fetching order details.');
            }
        }

        // --- Coupon Management ---
        async function fetchCouponsAdmin() {
            try {
                const response = await fetch(`${API_BASE_URL}/coupons`, {
                    headers: getAdminAuthHeaders()
                });
                const coupons = await response.json();
                renderCouponsTable(coupons);
            } catch (error) {
                console.error('Error fetching coupons for admin:', error);
                alert('Failed to load coupons for admin panel.');
            }
        }

        function renderCouponsTable(coupons) {
            const tableBody = document.getElementById('coupons-table-body');
            tableBody.innerHTML = '';
            if (coupons.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No coupons found.</td></tr>';
                return;
            }
            coupons.forEach(coupon => {
                const expires = coupon.expiresAt ? new Date(coupon.expiresAt).toLocaleDateString() : 'Never';
                const row = `
                    <tr>
                        <td>${coupon.id}</td>
                        <td>${coupon.code}</td>
                        <td>${coupon.discountType === 'percentage' ? 'Percentage' : 'Fixed'}</td>
                        <td>${coupon.discountType === 'percentage' ? `${parseFloat(coupon.discountValue)}%` : `€${parseFloat(coupon.discountValue).toFixed(2)}`}</td>
                        <td>€${parseFloat(coupon.minPurchase).toFixed(2)}</td>
                        <td>${coupon.currentUsage}/${coupon.usageLimit || '∞'}</td>
                        <td>${expires}</td>
                        <td>${coupon.isActive ? '<span class="text-green-600">Yes</span>' : '<span class="text-red-600">No</span>'}</td>
                        <td class="space-x-2">
                            <button class="btn-secondary text-sm" onclick="editCoupon(${coupon.id})">Edit</button>
                            <button class="btn-danger text-sm" onclick="deleteCoupon(${coupon.id})">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function openCouponModal(coupon = null) {
            const modal = document.getElementById('coupon-modal');
            const form = document.getElementById('coupon-form');
            form.reset();
            currentEditCouponId = null;

            document.getElementById('coupon-modal-title').textContent = 'Add New Coupon';
            document.getElementById('coupon-is-active').checked = true; // Default to active

            if (coupon) {
                document.getElementById('coupon-modal-title').textContent = 'Edit Coupon';
                currentEditCouponId = coupon.id;
                document.getElementById('coupon-code').value = coupon.code;
                document.getElementById('coupon-discount-type').value = coupon.discountType;
                document.getElementById('coupon-discount-value').value = parseFloat(coupon.discountValue);
                document.getElementById('coupon-min-purchase').value = parseFloat(coupon.minPurchase);
                document.getElementById('coupon-usage-limit').value = coupon.usageLimit || '';
                document.getElementById('coupon-expires-at').value = coupon.expiresAt ? new Date(coupon.expiresAt).toISOString().split('T')[0] : '';
                document.getElementById('coupon-is-active').checked = coupon.isActive;
            }
            modal.style.display = 'flex';
        }

        function closeCouponModal() {
            document.getElementById('coupon-modal').style.display = 'none';
        }

        document.getElementById('coupon-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                code: document.getElementById('coupon-code').value,
                discountType: document.getElementById('coupon-discount-type').value,
                discountValue: parseFloat(document.getElementById('coupon-discount-value').value),
                minPurchase: parseFloat(document.getElementById('coupon-min-purchase').value),
                usageLimit: document.getElementById('coupon-usage-limit').value ? parseInt(document.getElementById('coupon-usage-limit').value) : null,
                expiresAt: document.getElementById('coupon-expires-at').value ? new Date(document.getElementById('coupon-expires-at').value).toISOString() : null,
                isActive: document.getElementById('coupon-is-active').checked,
            };

            const method = currentEditCouponId ? 'PUT' : 'POST';
            const url = currentEditCouponId ? `${API_BASE_URL}/coupons/${currentEditCouponId}` : `${API_BASE_URL}/coupons`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAdminAuthHeaders(),
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    closeCouponModal();
                    fetchCouponsAdmin(); // Refresh table
                } else {
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('Coupon save error:', error);
                alert('An error occurred while saving the coupon.');
            }
        });

        async function editCoupon(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/coupons/${id}`, {
                    headers: getAdminAuthHeaders()
                });
                const coupon = await response.json();
                if (response.ok) {
                    openCouponModal(coupon);
                } else {
                    alert(`Error fetching coupon: ${coupon.message}`);
                }
            } catch (error) {
                console.error('Error fetching coupon for edit:', error);
                alert('An error occurred while fetching coupon for edit.');
            }
        }

        async function deleteCoupon(id) {
            if (!confirm('Are you sure you want to delete this coupon?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/coupons/${id}`, {
                    method: 'DELETE',
                    headers: getAdminAuthHeaders()
                });

                if (response.ok) {
                    alert('Coupon deleted successfully.');
                    fetchCouponsAdmin(); // Refresh table
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('Coupon delete error:', error);
                alert('An error occurred while deleting the coupon.');
            }
        }

        // --- User & Staff Management ---
        async function fetchUsersAdmin() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: getAdminAuthHeaders()
                });
                const users = await response.json();
                renderUsersTable(users);
            } catch (error) {
                console.error('Error fetching users for admin:', error);
                alert('Failed to load users for admin panel.');
            }
        }

        function renderUsersTable(users) {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No users found.</td></tr>';
                return;
            }
            users.forEach(user => {
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.fullName}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td class="space-x-2">
                            <button class="btn-secondary text-sm" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn-danger text-sm" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function openUserModal(user = null) {
            const modal = document.getElementById('user-modal');
            const form = document.getElementById('user-form');
            form.reset();
            currentEditUserId = null;

            document.getElementById('user-modal-title').textContent = 'Add New Staff/Admin';
            document.getElementById('user-password').required = true; // Password required for new users

            if (user) {
                document.getElementById('user-modal-title').textContent = 'Edit User';
                currentEditUserId = user.id;
                document.getElementById('user-fullname').value = user.fullName;
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-password').required = false; // Password not required for edit
                document.getElementById('user-role').value = user.role;
            }
            modal.style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
        }

        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                fullName: document.getElementById('user-fullname').value,
                email: document.getElementById('user-email').value,
                role: document.getElementById('user-role').value,
            };

            const password = document.getElementById('user-password').value;
            if (password) { // Only include password if provided (for new users or password change)
                formData.password = password;
            }

            const method = currentEditUserId ? 'PUT' : 'POST';
            const url = currentEditUserId ? `${API_BASE_URL}/users/${currentEditUserId}` : `${API_BASE_URL}/users/staff`; // Use /users/staff for new staff/admin

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAdminAuthHeaders(),
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    closeUserModal();
                    fetchUsersAdmin(); // Refresh table
                } else {
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('User save error:', error);
                alert('An error occurred while saving the user.');
            }
        });

        async function editUser(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${id}`, {
                    headers: getAdminAuthHeaders()
                });
                const user = await response.json();
                if (response.ok) {
                    openUserModal(user);
                } else {
                    alert(`Error fetching user: ${user.message}`);
                }
            } catch (error) {
                console.error('Error fetching user for edit:', error);
                alert('An error occurred while fetching user for edit.');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${id}`, {
                    method: 'DELETE',
                    headers: getAdminAuthHeaders()
                });

                if (response.ok) {
                    alert('User deleted successfully.');
                    fetchUsersAdmin(); // Refresh table
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('User delete error:', error);
                alert('An error occurred while deleting the user.');
            }
        }


        // --- Initial Load Check for Admin Panel ---
        window.addEventListener('load', () => {
            if (adminAuthToken && adminCurrentUser) {
                document.getElementById('admin-login-page').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                showAdminPage('dashboard'); // Show dashboard if already logged in
            } else {
                document.getElementById('admin-login-page').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
